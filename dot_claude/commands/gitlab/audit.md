---
name: audit
description: "Аудит GitLab репозиториев — поиск чувствительных данных (IP, домены, секреты)"
category: security
complexity: medium
mcp-servers: []
personas: []
---

# /gitlab:audit - Аудит GitLab репозиториев

Поиск чувствительных данных (IP-адресов, доменов, секретов) по всем склонированным GitLab проектам.

## Triggers
- Поиск IP-адресов в коде
- Поиск доменов и URL
- Аудит секретов и конфигураций
- Проверка упоминаний серверов/сервисов

## Usage
```
/gitlab:audit <pattern> [--context] [--exclude-csv] [--exclude-json]
```

**Аргументы:**
- `<pattern>` — строка для поиска (IP, домен, любой текст)
- `--context` — показать 3 строки контекста вокруг найденного
- `--exclude-csv` — исключить CSV файлы из поиска
- `--exclude-json` — исключить JSON файлы из поиска

## Требования

- **ripgrep (rg)** — быстрый поиск по тексту (версия 11.0+)
- Склонированные репозитории в директории аудита (по умолчанию `~/ops/gitlab_audit`)

## Директория репозиториев

```bash
# По умолчанию (можно переопределить через аргумент)
GITLAB_AUDIT_DIR="${1:-$HOME/ops/gitlab_audit}"
```

## Behavioral Flow

Когда пользователь вызывает `/gitlab:audit <pattern>`:

1. **Проверка окружения**
   ```bash
   # Проверить наличие и версию ripgrep
   rg --version || echo "ripgrep не установлен: brew install ripgrep"

   # Проверить директорию с репозиториями
   ls "$GITLAB_AUDIT_DIR" || echo "Директория не найдена. Сначала выполни /gitlab:clone"
   ```

2. **Подготовка паттерна**
   - Экранировать спецсимволы regex (точки в IP → `\.`)
   - Если паттерн содержит `|` — это OR-поиск нескольких значений

   Примеры преобразования:
   | Ввод | Паттерн для rg |
   |------|----------------|
   | `10.12.11.10` | `10\.12\.11\.10` |
   | `example.com` | `example\.com` |
   | `10.12.11.10\|prod.example.com` | `10\.12\.11\.10\|prod\.example\.com` |

3. **Выполнение поиска**
   ```bash
   # Базовый поиск (с таймаутом для больших репозиториев)
   timeout 300 rg "<escaped_pattern>" "$GITLAB_AUDIT_DIR"

   # С контекстом
   timeout 300 rg "<escaped_pattern>" "$GITLAB_AUDIT_DIR" -C 3

   # С исключениями
   timeout 300 rg "<escaped_pattern>" "$GITLAB_AUDIT_DIR" --glob "!*.csv" --glob "!*.json"
   ```

4. **Анализ результатов**
   - Сгруппировать по репозиториям/папкам
   - Определить тип файла (конфиг, скрипт, бэкап)
   - Выделить критичные находки (credentials, API keys)

5. **Вывод отчёта**
   Формат вывода:
   ```
   ## Результаты аудита для: <pattern>

   ### Найдено в <repo-name>/
   | Файл | Строка | Контекст |
   |------|--------|----------|
   | path/to/file.yaml | 42 | содержимое строки |

   ### Сводка
   - Всего найдено: N вхождений в M файлах
   - Репозитории: список затронутых репо
   - Типы файлов: .yaml, .sh, .ps1, etc.
   ```

## Примеры использования

### Поиск IP-адреса
```
/gitlab:audit 10.12.11.10
```

### Поиск домена
```
/gitlab:audit prod.example.com
```

### Поиск нескольких паттернов (OR)
```
/gitlab:audit "10.12.11.10|staging.example.com"
```

### Поиск с контекстом, без CSV
```
/gitlab:audit 10.12.11.10 --context --exclude-csv
```

## Клонирование репозиториев (подготовка)

Репозитории уже склонированы в:
```
/Users/alexeyprudkin/ops/gitlab_audit
```

Для обновления или повторного клонирования используй `/gitlab:clone`.

## Интерпретация результатов

| Тип файла | Значение |
|-----------|----------|
| `.yaml`, `.yml` | Конфигурации, возможно sensitive |
| `.sh`, `.ps1` | Скрипты автоматизации |
| `.csv`, `.json` | Часто бэкапы/экспорты, много шума |
| `.env`, `credentials*` | КРИТИЧНО — секреты |
| `*config*`, `*settings*` | Конфигурации приложений |

## Советы

- **Много результатов?** Используй `--exclude-csv --exclude-json`
- **Нужен контекст?** Добавь `--context`
- **Ищешь секреты?** Попробуй паттерны: `password`, `api_key`, `secret`, `token`
